name: Deploy Blue-Green

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v3

      # ðŸ”‘ 1. CONFIGURACIÃ“N SSH MEJORADA
      - name: ðŸ”‘ Write Private Key and Add Host
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H 35.230.70.157 >> ~/.ssh/known_hosts
          
          # Verificar que la clave se creÃ³ correctamente
          ls -la ~/.ssh/
          # Verificar el formato de la clave
          head -n 1 ~/.ssh/deploy_key

      # ðŸš€ 2. DESPLIEGUE GREEN (CORREGIDO)
      - name: ðŸš€ Deploy Green Server
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key jennifer13br2004@35.230.70.157 << 'ENDSSH'
            echo "Iniciando pull en el repositorio..."
            cd ~/Estrategia-Blue---Green
            git pull origin main

            echo "Ejecutando despliegue Green con docker-compose..."
            bash scripts/deploy-green.sh || exit 1

            echo "Despliegue Green completado."
          ENDSSH

      # ðŸ©º 3. HEALTH CHECK GREEN
      - name: ðŸ©º Health Check Green Server
        run: |
          echo "Realizando verificaciÃ³n de salud (Health Check) en el servidor Green..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key jennifer13br2004@35.230.70.157 << 'ENDSSH'
            docker ps | grep frontend_green || exit 1
            curl -f http://localhost:3001 || exit 1
            echo "Health Check exitoso en el servidor Green."
          ENDSSH

      # ðŸ”„ 4. SWITCH DE TRAFICO (CORREGIDO)
      - name: ðŸ”„ Switch Traffic to Green
        run: |
          echo "Cambiando el trÃ¡fico al servidor Green..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key jennifer13br2004@35.230.70.157 << 'ENDSSH'
            cd ~/Estrategia-Blue---Green
            chmod +x scripts/switch.sh
            bash scripts/switch.sh green
          ENDSSH
