name: Deploy Blue-Green

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v3

      # ğŸ”‘ CONFIGURACIÃ“N SSH - VERIFICACIÃ“N COMPLETA
      - name: ğŸ”‘ Setup SSH Connection
        run: |
          mkdir -p ~/.ssh
          # Escribir la clave privada
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Agregar host conocido
          ssh-keyscan -H 35.230.70.157 >> ~/.ssh/known_hosts
          
          # VERIFICACIONES
          echo "=== Verificando clave SSH ==="
          ls -la ~/.ssh/deploy_key
          echo "=== Primeras lÃ­neas de la clave ==="
          head -n 2 ~/.ssh/deploy_key
          echo "=== Verificando formato ==="
          file ~/.ssh/deploy_key

      # ğŸ” TEST DE CONEXIÃ“N PRIMERO
      - name: ğŸ” Test SSH Connection
        run: |
          echo "Probando conexiÃ³n SSH..."
          ssh -o BatchMode=yes -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key jennifer13br2004@35.230.70.157 "echo 'âœ… CONEXIÃ“N SSH EXITOSA'" 

      # ğŸš€ DESPLIEGUE GREEN - COMANDO CORREGIDO
      - name: ğŸš€ Deploy Green Server
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key jennifer13br2004@35.230.70.157 << 'ENDSSH'
            echo "ğŸ“ Directorio actual: $(pwd)"
            echo "ğŸ‘¤ Usuario: $(whoami)"
            
            echo "ğŸ“¥ Iniciando pull en el repositorio..."
            cd ~/Estrategia-Blue---Green
            git pull origin main

            echo "ğŸ³ Ejecutando despliegue Green con docker-compose..."
            bash scripts/deploy-green.sh || exit 1

            echo "âœ… Despliegue Green completado."
          ENDSSH

      # ğŸ©º HEALTH CHECK GREEN
      - name: ğŸ©º Health Check Green Server
        run: |
          echo "ğŸ¥ Realizando Health Check en servidor Green..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key jennifer13br2004@35.230.70.157 << 'ENDSSH'
            echo "ğŸ” Verificando contenedores..."
            docker ps | grep frontend_green || exit 1
            echo "ğŸŒ Verificando servicio web..."
            curl -f http://localhost:3001 || exit 1
            echo "âœ… Health Check exitoso en servidor Green."
          ENDSSH

      # ğŸ”„ SWITCH DE TRAFICO
      - name: ğŸ”„ Switch Traffic to Green
        run: |
          echo "ğŸ”„ Cambiando trÃ¡fico a servidor Green..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key jennifer13br2004@35.230.70.157 << 'ENDSSH'
            cd ~/Estrategia-Blue---Green
            chmod +x scripts/switch.sh
            bash scripts/switch.sh green
            echo "âœ… TrÃ¡fico cambiado a Green exitosamente."
          ENDSSH
