name: Deploy Blue-Green

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v3

      # ðŸ“œ 1. AGREGAR HOST AL known_hosts (VERSIÃ“N ROBUSTA)
      - name: ðŸ“œ Add Known Host
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Intentamos escanear el host. El '2>/dev/null' ignora errores de red/conexiÃ³n.
          ssh-keyscan -H 35.230.70.157 >> ~/.ssh/known_hosts 2>/dev/null || true

      # ðŸš€ 2. DESPLIEGUE GREEN Y HEALTH CHECK
      - name: ðŸš€ Deploy Green Server and Check Health
        uses: appleboy/ssh-action@v1.0.1
        with:
          host: 35.230.70.157
          username: jennifer13br2004
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            echo "Iniciando pull en el repositorio..."
            cd ~/Estrategia-Blue---Green
            git pull origin main

            echo "Ejecutando despliegue Green con docker-compose..."
            bash scripts/deploy-green.sh || exit 1

            echo "Realizando verificaciÃ³n de salud (Health Check) en el servidor Green..."
            docker ps | grep frontend_green || exit 1
            curl -I http://localhost:3001 || exit 1
            echo "Health Check exitoso en el servidor Green."

      # ðŸ”„ 3. SWITCH DE TRAFICO Y ACTUALIZACIÃ“N DE ESTADO EN .ENV
      - name: ðŸ”„ Switch Traffic to Green (Update Router and .env)
        uses: appleboy/ssh-action@v1.0.1
        with:
          host: 35.230.70.157
          username: jennifer13br2004
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            echo "Cambiando el trÃ¡fico al servidor Green..."
            cd ~/Estrategia-Blue---Green
            bash scripts/switch.sh green
            sed -i 's/^CURRENT_DEPLOYMENT=.*/CURRENT_DEPLOYMENT=green/' .env
            echo "Estado de CURRENT_DEPLOYMENT actualizado a green en .env. Despliegue completado."
