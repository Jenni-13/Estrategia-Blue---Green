name: Deploy Blue-Green

on:
  push:
    branches:name: Deploy Blue-Green
  on:
    push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: 拘勇 Checkout Code
        uses: actions/checkout@v3

      # 游닆 1. AGREGAR HOST AL known_hosts (El "switch" de verificaci칩n)
      # Esto previene el error "Host key verification failed" que puede ser el "switch" faltante.
      - name: 游닆 Add Known Host
        run: ssh-keyscan -H 35.230.70.157 >> ~/.ssh/known_hosts

      # 游 2. DESPLIEGUE GREEN Y HEALTH CHECK
      - name: 游 Deploy Green Server and Check Health
        uses: appleboy/ssh-action@v1.0.1
        with:
          host: 35.230.70.157
          username: jennifer13br2004
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true # Detiene el workflow si alg칰n comando falla en el servidor
          script: |
            echo "Iniciando pull en el repositorio..."
            cd ~/Estrategia-Blue---Green
            git pull origin main

            echo "Ejecutando despliegue Green con docker-compose..."
            bash scripts/deploy-green.sh || exit 1 # Falla si el deploy falla

            echo "Realizando verificaci칩n de salud (Health Check) en el servidor Green..."
            # 1. Verificar si el contenedor Green est치 corriendo
            docker ps | grep frontend_green || exit 1
            # 2. Verificar si la aplicaci칩n Green responde (puerto 3001)
            curl -I http://localhost:3001 || exit 1
            echo "Health Check exitoso en el servidor Green."

      # 游댃 3. SWITCH DE TRAFICO Y ACTUALIZACI칍N DE ESTADO EN .ENV
      - name: 游댃 Switch Traffic to Green (Update Router and .env)
        uses: appleboy/ssh-action@v1.0.1
        with:
          host: 35.230.70.157
          username: jennifer13br2004
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            echo "Cambiando el tr치fico al servidor Green..."
            cd ~/Estrategia-Blue---Green
            
            # 1. Ejecuta el script de enrutamiento (cambio de proxy)
            bash scripts/switch.sh green
            
            # 2. ACTUALIZA EL ESTADO CONDICIONAL EN EL ARCHIVO .ENV
            # Esto establece Green como el entorno activo
            sed -i 's/^CURRENT_DEPLOYMENT=.*/CURRENT_DEPLOYMENT=green/' .env
            
            echo "Estado de CURRENT_DEPLOYMENT actualizado a green en .env. Despliegue completado."
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: 拘勇 Checkout Code
        uses: actions/checkout@v3

      # 游 1. DESPLIEGUE GREEN Y HEALTH CHECK (COMBINADO EN UN PASO)
      - name: 游 Deploy Green Server and Check Health
        uses: appleboy/ssh-action@v1.0.1 # Usando la versi칩n m치s reciente
        with:
          # Par치metros de conexi칩n
          host: 35.230.70.157
          username: jennifer13br2004
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # 游뚿 Importante: Evita la verificaci칩n de host.
          # Aseg칰rate de que esto solo se haga en entornos controlados,
          # o mejor, usa 'ssh-keyscan' en un paso previo.
          # Si usas known_hosts en un paso previo, puedes omitir 'insecure'
          script_stop: true
          # 游닆 Script a ejecutar en el servidor remoto
          script: |
            echo "Iniciando pull en el repositorio..."
            cd ~/Estrategia-Blue---Green
            git pull origin main

            echo "Ejecutando despliegue Green con docker-compose..."
            bash scripts/deploy-green.sh || exit 1 # Falla si el script falla

            echo "Realizando verificaci칩n de salud (Health Check) en el servidor Green..."
            docker ps | grep frontend_green || exit 1
            curl -I http://localhost:3001 || exit 1
            echo "Health Check exitoso en el servidor Green."

      # 游댃 2. SWITCH DE TRAFICO
      - name: 游댃 Switch Traffic to Green (Cambio de Router)
        uses: appleboy/ssh-action@v1.0.1
        with:
          # Par치metros de conexi칩n (Reutilizados)
          host: 35.230.70.157
          username: jennifer13br2004
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          # 游닆 Script para cambiar el tr치fico
          script: |
            echo "Cambiando el tr치fico al servidor Green..."
            cd ~/Estrategia-Blue---Green
            chmod +x scripts/switch.sh
            bash scripts/switch.sh green
