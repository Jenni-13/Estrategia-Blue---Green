name: Deploy Blue-Green

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v3

      # üîë CONFIGURACI√ìN SSH MEJORADA
      - name: üîë Write Private Key and Add Host
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # ESCRIBIR CLAVE PRIVADA CON FORMATO CORRECTO
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/bluegreen_key
          
          # LIMPIAR Y FORMATEAR LA CLAVE
          sed -i '/^$/d' ~/.ssh/bluegreen_key  # Eliminar l√≠neas vac√≠as
          sed -i 's/\\n/\n/g' ~/.ssh/bluegreen_key  # Convertir \n a saltos de l√≠nea reales
          
          # VERIFICAR FORMATO DE CLAVE
          echo "=== Verificando formato de clave ==="
          head -n 3 ~/.ssh/bluegreen_key
          
          # PERMISOS CORRECTOS
          chmod 600 ~/.ssh/bluegreen_key
          
          # AGREGAR HOST A known_hosts
          ssh-keyscan -H 35.230.70.157 >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
          
          # VERIFICAR CONEXI√ìN SSH
          echo "=== Probando conexi√≥n SSH ==="
          ssh -i ~/.ssh/bluegreen_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 jennifer13br2004@35.230.70.157 "echo 'Conexi√≥n SSH exitosa!'"

      # üöÄ DESPLIEGUE GREEN (CON M√ÅS VERBOSIDAD)
      - name: üöÄ Deploy Green Server
        run: |
          echo "=== Iniciando despliegue en Green Server ==="
          ssh -i ~/.ssh/bluegreen_key -o StrictHostKeyChecking=no -o ConnectTimeout=30 jennifer13br2004@35.230.70.157 << 'EOF'
            echo "1. Directorio actual: $(pwd)"
            echo "2. Listando archivos:"
            ls -la
            echo "3. Navegando al repositorio..."
            cd ~/Estrategia-Blue---Green || { echo "Error: No se pudo acceder al directorio"; exit 1; }
            echo "4. Realizando pull del repositorio..."
            git pull origin main
            echo "5. Verificando scripts de despliegue..."
            ls -la scripts/
            echo "6. Ejecutando despliegue Green..."
            bash scripts/deploy-green.sh
            echo "‚úÖ Despliegue Green completado exitosamente"
             EOF

      # Los dem√°s pasos permanecen igual...
      - name: ü©∫ Health Check Green Server
        run: |
          echo "Realizando Health Check..."
          ssh -i ~/.ssh/bluegreen_key -o StrictHostKeyChecking=no jennifer13br2004@35.230.70.157 << 'EOF'
            echo "Contenedores ejecut√°ndose:"
            docker ps
            echo "Verificando frontend_green..."
            docker ps | grep frontend_green || echo "‚ö†Ô∏è frontend_green no encontrado"
            echo "Probando servicio en puerto 3001..."
            curl -f http://localhost:3001 || echo "‚ö†Ô∏è Servicio no responde en puerto 3001"
            EOF

      - name: üîÑ Switch Traffic to Green
        run: |
          echo "Cambiando tr√°fico a Green..."
          ssh -i ~/.ssh/bluegreen_key -o StrictHostKeyChecking=no jennifer13br2004@35.230.70.157 << 'EOF'
            cd ~/Estrategia-Blue---Green
            chmod +x scripts/switch.sh
            bash scripts/switch.sh green
            echo "‚úÖ Tr√°fico cambiado a Green exitosamente"
             EOF
