name: Deploy Blue-Green

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v3

      # ğŸ”‘ 1. CONFIGURACIÃ“N SSH MEJORADA
      - name: ğŸ”‘ Write Private Key and Add Host
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # ESCRIBIR CLAVE CORRECTAMENTE
          cat << 'KEY_EOF' > ~/.ssh/deploy_key
          ${{ secrets.SSH_PRIVATE_KEY }}
          KEY_EOF
          
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H 35.230.70.157 >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
          
          # VERIFICAR LA CLAVE
          echo "=== Verificando clave SSH ==="
          ls -la ~/.ssh/deploy_key
          head -n 2 ~/.ssh/deploy_key

      # ğŸ” 2. TEST DE CONEXIÃ“N (NUEVO PASO)
      - name: ğŸ” Test SSH Connection
        run: |
          echo "=== Probando conexiÃ³n SSH ==="
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o LogLevel=ERROR \
              jennifer13br2004@35.230.70.157 "echo 'âœ… ConexiÃ³n SSH exitosa'"

      # ğŸš€ 3. DESPLIEGUE GREEN
      - name: ğŸš€ Deploy Green Server
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no jennifer13br2004@35.230.70.157 << 'DEPLOY_EOF'
            echo "Iniciando pull en el repositorio..."
            cd ~/Estrategia-Blue---Green
            git pull origin main
            echo "Ejecutando despliegue Green con docker-compose..."
            bash scripts/deploy-green.sh || exit 1
            echo "Despliegue Green completado."
            DEPLOY_EOF

      # ğŸ©º 4. HEALTH CHECK GREEN
      - name: ğŸ©º Health Check Green Server
        run: |
          echo "Realizando verificaciÃ³n de salud (Health Check) en el servidor Green..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no jennifer13br2004@35.230.70.157 << 'HEALTH_EOF'
            echo "Contenedores ejecutÃ¡ndose:"
            docker ps
            echo "Verificando frontend_green..."
            docker ps | grep frontend_green || { echo "âŒ frontend_green no encontrado"; exit 1; }
            echo "Probando servicio..."
            curl -f http://localhost:3001 || { echo "âŒ Servicio no responde"; exit 1; }
            echo "Health Check exitoso en el servidor Green."
           HEALTH_EOF

      # ğŸ”„ 5. SWITCH DE TRAFICO
      - name: ğŸ”„ Switch Traffic to Green
        run: |
          echo "Cambiando el trÃ¡fico al servidor Green..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no jennifer13br2004@35.230.70.157 << 'SWITCH_EOF'
            cd ~/Estrategia-Blue---Green
            chmod +x scripts/switch.sh
            bash scripts/switch.sh green
            echo "âœ… TrÃ¡fico cambiado a Green"
         SWITCH_EOF
