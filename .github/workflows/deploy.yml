name: Deploy Blue-Green

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    environment: production

    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v3

     # ðŸ”‘ 1. CONFIGURACIÃ“N SSH MANUAL (SOLUCIÃ“N AL 'Permission denied')
      # Usamos 'sed' para escribir la clave privada MANTENIENDO los saltos de lÃ­nea.
      - name: ðŸ”‘ Write Private Key and Add Host
        run: |
          # Crear directorio SSH
          mkdir -p ~/.ssh

          # Escribir el secreto de GitHub al archivo, manejando los saltos de lÃ­nea (CRÃTICO)
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | sed 's/\\n/\n/g' > ~/.ssh/deploy_key
          
          # Asignar permisos seguros a la clave privada (OBLIGATORIO para SSH)
          chmod 600 ~/.ssh/deploy_key

          # ðŸ›¡ï¸ AÃ±adir el host a known_hosts (IP: 34.83.114.79)
          ssh-keyscan -H 34.83.114.79 >> ~/.ssh/known_hosts

      # ðŸš€ 2. DESPLIEGUE GREEN
      - name: ðŸš€ Deploy Green Server
        run: |
          # Usamos -i para indicar la clave, en lugar de depender del ssh-agent
          ssh -i ~/.ssh/deploy_key jennifer13br2004@34.83.114.79 << 'EOF'
            echo "Iniciando pull en el repositorio..."
            cd ~/Estrategia-Blue---Green
            git pull origin main

            echo "Ejecutando despliegue Green con docker-compose..."
            # ðŸŸ¢ Llamamos al script que usa docker-compose (deploy-green.sh)
            bash scripts/deploy-green.sh || exit 1 
            
            echo "Despliegue Green completado."
          EOF

      # ðŸ©º 3. HEALTH CHECK GREEN
      - name: ðŸ©º Health Check Green Server
        run: |
          echo "Realizando verificaciÃ³n de salud (Health Check) en el servidor Green..."
          ssh -i ~/.ssh/deploy_key jennifer13br2004@34.83.114.79 << 'EOF'
            # ðŸŸ¢ Verificamos el endpoint raÃ­z ('/') del frontend en el puerto 3001
            # Si esto falla, el Health Check falla y el pipeline se detiene
            curl -f http://localhost:3001 || exit 1 
            echo "Health Check exitoso en el servidor Green."
          EOF

      # ðŸ”„ 4. CAMBIAR TRÃFICO A GREEN
      - name: ðŸ”„ Switch Traffic to Green (Cambio de Router)
        run: |
          echo "Cambiando el trÃ¡fico al servidor Green..."
          ssh -i ~/.ssh/deploy_key jennifer13br2004@34.83.114.79 << 'EOF'
            # ðŸŸ¢ Pasamos el argumento 'green' al script
            bash scripts/switch.sh green
          EOF
