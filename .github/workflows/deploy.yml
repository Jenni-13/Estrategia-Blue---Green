name: Deploy Blue-Green

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # Define un entorno para mejor seguimiento de secretos y despliegues
    environment: production # Puedes cambiar 'production' por el nombre de tu entorno

    steps:
      - name: 拘勇 Checkout Code
        uses: actions/checkout@v3

      - name: 游댐 Setup SSH Connection
        run: |
          # 1. Crear el directorio SSH con permisos restringidos (700)
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # 2. Escribir la clave privada. 
          #    Usamos printf para manejar correctamente los saltos de l칤nea (la mejor pr치ctica).
          printf "%s\n" "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          
          # 3. Restringir permisos a la clave privada (600)
          chmod 600 ~/.ssh/deploy_key
          
          # 4. A침adir el host al known_hosts para evitar la pregunta de confirmaci칩n
          ssh-keyscan -H 34.83.114.79 >> ~/.ssh/known_hosts

      - name: 游 Deploy Green Server
        # Aseg칰rate de que el usuario jennifer13br2004 exista y tenga la clave p칰blica autorizada
        run: |
          ssh -i ~/.ssh/deploy_key jennifer13br2004@34.83.114.79 << 'EOF'
            echo "Iniciando pull en el repositorio..."
            cd ~/Estrategia-Blue---Green
            git pull origin main

            echo "Ejecutando despliegue Green..."
            bash scripts/deploy-green.sh
          EOF

      - name: 游뽘 Health Check Green Server
        # El if: success() del siguiente paso ya no es necesario si este falla
        run: |
          echo "Realizando verificaci칩n de salud (Health Check) en el servidor Green..."
          ssh -i ~/.ssh/deploy_key jennifer13br2004@34.83.114.79 << 'EOF'
            # curl -f asegura que el comando falle (exit code 1) si el c칩digo de respuesta es 4xx/5xx
            curl -f http://localhost:8080 || exit 1
            curl -f http://localhost:3001/health || exit 1
            echo "Health Check exitoso."
          EOF

      - name: 游댃 Switch Traffic to Green (Cambio de Router)
        # Solo se ejecuta si los pasos anteriores fueron exitosos
        run: |
          echo "Cambiando el tr치fico al servidor Green..."
          ssh -i ~/.ssh/deploy_key jennifer13br2004@34.83.114.79 << 'EOF'
            # Ejecutar script que modifica la configuraci칩n de Nginx/balanceador
            bash scripts/switch.sh
          EOF
