name: Deploy Blue-Green

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v3

      # ğŸ”‘ CONFIGURACIÃ“N SSH
      - name: ğŸ”‘ Setup SSH Connection
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H 35.230.70.157 >> ~/.ssh/known_hosts

      # ğŸ” VERIFICAR CLAVE PRIMERO
      - name: ğŸ” Verify SSH Key
        run: |
          echo "=== Verificando clave SSH ==="
          ls -la ~/.ssh/
          echo "Formato:"
          file ~/.ssh/deploy_key
          echo "Primeras lÃ­neas:"
          head -n 2 ~/.ssh/deploy_key

      # ğŸš€ DESPLIEGUE
      - name: ğŸš€ Deploy Green Server
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key jennifer13br2004@35.230.70.157 << 'ENDSSH'
            echo "âœ… Conectado al servidor exitosamente"
            echo "ğŸ“ Directorio: $(pwd)"
            echo "ğŸ“¥ Actualizando repositorio..."
            cd ~/Estrategia-Blue---Green
            git pull origin main
            echo "ğŸ³ Ejecutando despliegue..."
            bash scripts/deploy-green.sh
            echo "âœ… Despliegue completado"
          ENDSSH
