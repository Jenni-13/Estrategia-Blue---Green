name: Deploy Blue-Green

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v3

      # üîë 1. CONFIGURACI√ìN SSH MANUAL
      - name: üîë Write Private Key and Add Host
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/bluegreen_key
          chmod 600 ~/.ssh/bluegreen_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          
          # Verificar que la clave se cre√≥ correctamente
          ls -la ~/.ssh/
          # Verificar el formato de la clave
          head -n 1 ~/.ssh/bluegreen_key

      # üîç DEBUG SSH CONNECTION
      - name: üîç Debug SSH Connection
        run: |
          echo "=== Testing SSH connection ==="
          ssh -o BatchMode=yes -o ConnectTimeout=5 -i ~/.ssh/bluegreen_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "echo 'SSH connection successful'" || echo "SSH connection failed"
          
          echo "=== Testing SSH with verbose ==="
          ssh -vvv -o BatchMode=yes -o ConnectTimeout=5 -i ~/.ssh/bluegreen_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "echo 'SSH connection successful'" || true

      # üöÄ 2. DESPLIEGUE GREEN
      - name: üöÄ Deploy Green Server
        run: |
          ssh -o BatchMode=yes -i ~/.ssh/bluegreen_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            echo "Iniciando pull en el repositorio..."
            cd ~/Estrategia-Blue--Green
            git pull origin main
            echo "Ejecutando despliegue Green con docker-compose..."
            bash scripts/deploy-green.sh || exit 1
            echo "Despliegue Green completado."
          EOF

      # ü©∫ 3. HEALTH CHECK GREEN
      - name: ü©∫ Health Check Green Server
        run: |
          echo "Realizando verificaci√≥n de salud (Health Check) en el servidor Green..."
          ssh -o BatchMode=yes -i ~/.ssh/bluegreen_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            docker ps | grep frontend_green || exit 1
            curl -f http://localhost:3001 || exit 1
            echo "Health Check exitoso en el servidor Green."
          EOF

      # üîÑ 4. SWITCH DE TRAFICO
      - name: üîÑ Switch Traffic to Green (Cambio de Router)
        run: |
          echo "Cambiando el tr√°fico al servidor Green..."
          ssh -o BatchMode=yes -i ~/.ssh/bluegreen_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            cd ~/Estrategia-Blue--Green
            chmod +x scripts/switch.sh
            bash scripts/switch.sh green
          EOF
